<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- PWA manifest 연결 -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2d89ef" />
  <meta charset="UTF-8" />
  <title>부조금 프로그램</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" />
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f6f6f6;
    }
    .container {
      width: 90%;
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 24px 32px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    form, #batchForm {
      margin-bottom: 20px;
    }
    input, button, textarea {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #d1d5db;
      margin-right: 10px;
    }
    button {
      background: #2d89ef;
      color: white;
      border: none;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #e8eaf6;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f0f0f0;
    }
    textarea {
      width: 100%;
      font-family: monospace;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>부조금 내역 입력</h1>
    <form id="fundForm">
      <input type="text" id="name" placeholder="성명" required />
      <input type="text" id="phone" placeholder="연락처" required />
      <input type="date" id="date" required />
      <input type="text" id="purpose" placeholder="명목" required />
      <input type="number" id="deposit" placeholder="입금액" min="0" />
      <input type="number" id="withdrawal" placeholder="출금액" min="0" />
      <button type="submit">추가</button>
    </form>

    <form id="batchForm">
      <textarea id="csvInput" rows="10" placeholder="성명,연락처,일자,명목,입금액,출금액 (CSV 형식으로 입력 또는 붙여넣기)"></textarea>
      <button type="submit">일괄 추가</button>
    </form>

    <table id="fundTable" class="display">
      <thead>
        <tr>
          <th>성명</th>
          <th>연락처</th>
          <th>일자</th>
          <th>명목</th>
          <th>입금액</th>
          <th>출금액</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jQuery and DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

  <script>
    // 로컬스토리지 키
    const STORAGE_KEY = 'fundData';

    // DataTables 초기화 전 데이터 로드
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    }

    // 데이터 저장
    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // 테이블에 행 추가 (DataTables API 이용)
    function addRowToTable(dt, entry) {
      dt.row.add([
        entry.name,
        entry.phone,
        entry.date,
        entry.purpose,
        entry.deposit || '',
        entry.withdrawal || ''
      ]).draw(false);
    }

    $(document).ready(function() {
      let dataSet = loadData();

      // DataTable 생성
      const table = $('#fundTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
      });

      // 기존 데이터 로드
      dataSet.forEach(entry => {
        addRowToTable(table, entry);
      });

      // 단일 행 추가 폼 처리
      $('#fundForm').on('submit', function(e) {
        e.preventDefault();
        const entry = {
          name: $('#name').val().trim(),
          phone: $('#phone').val().trim(),
          date: $('#date').val(),
          purpose: $('#purpose').val().trim(),
          deposit: $('#deposit').val().trim(),
          withdrawal: $('#withdrawal').val().trim()
        };

        // 기본 필수 필드 체크
        if(!entry.name || !entry.phone || !entry.date || !entry.purpose) {
          alert('성명, 연락처, 일자, 명목은 필수 입력 항목입니다.');
          return;
        }

        dataSet.push(entry);
        saveData(dataSet);
        addRowToTable(table, entry);
        this.reset();
      });

      // CSV 일괄 추가 폼 처리
      $('#batchForm').on('submit', function(e) {
        e.preventDefault();
        const rawData = $('#csvInput').val().trim();
        if (!rawData) {
          alert('CSV 데이터를 입력하세요.');
          return;
        }

        const lines = rawData.split('\n');
        let addedCount = 0;

        lines.forEach(line => {
          const cols = line.split(',');
          if(cols.length < 4) return; // 최소 필수 4개 체크
          const entry = {
            name: cols[0].trim(),
            phone: cols[1].trim(),
            date: cols[2].trim(),
            purpose: cols[3].trim(),
            deposit: cols[4] ? cols[4].trim() : '',
            withdrawal: cols[5] ? cols[5].trim() : ''
          };
          if(!entry.name || !entry.phone || !entry.date || !entry.purpose) return;

          dataSet.push(entry);
          addRowToTable(table, entry);
          addedCount++;
        });

        if (addedCount === 0) {
          alert('유효한 데이터가 없습니다.');
        } else {
          saveData(dataSet);
          alert(`${addedCount}건이 추가되었습니다.`);
          this.reset();
        }
      });
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('서비스워커 등록됨!'))
      .catch(console.error);
    }
  </script>
  <button id="installBtn" style="display:none; position: fixed; bottom: 12px; right: 12px; padding: 10px 15px; background: #2d89ef; color: white; border:none; border-radius: 5px; cursor: pointer;">앱 설치하기</button>

<script>
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      alert('부조금관리 프로그램이 설치되었습니다!');
      installBtn.style.display = 'none';
      deferredPrompt = null;
    }
  });
</script>

</body>
</html>
